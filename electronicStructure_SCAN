# pending: program description

from pymatgen.io.quantumespresso import PWInput

# loads relaxed structure from PBEsol

structure_relaxed = Structure.from_file("relax_pbesol.out")

# generates input for SCAN calculation

input_scan = PWInput

(
    structure_relaxed, pseudopotentials = 
    
    {
        "Pb": "Pb.scan-rrkjus_psl.1.0.0.UPF",
        "Cu": "Cu.scan-rrkjus_psl.1.0.0.UPF",
        "P": "P.scan-rrkjus_psl.1.0.0.UPF",
        "O": "O.scan-rrkjus_psl.1.0.0.UPF",
    },

    control = {"calculation": "scf", "tstress": True},
    system = 
    
    {
        "ecutwfc": 70,  # a higher cutoff for SCAN
        "ecutrho": 560,
        "input_dft": "SCAN",
        "occupations": "smearing",
        "smearing": "mv",
        "degauss": 0.01,
    },

    kpts = (6, 6, 6),  # denser k-grid (for accuracy)
)

input_scan.write_file("scan_scf.in")

# runs Quantum ESPRESSO with SCAN

!mpirun -np 4 pw.x -in scan_scf.in > scan_scf.out

# verifies completion & downloads output

if "JOB COMPLETED" in open("scan_scf.out").read():

    print("SCAN calculation worked!")
    display(FileLink("scan_scf.out")) 

else:

    print("SCAN calculation failed. Check scan_scf.out.")
